pipeline {
   agent { label "java"}

    tools{
        gradle 'Gradle-5.4'
    }

      environment{
        GRADLE_OPTS='-Dorg.gradle.daemon=true -Xmx1024m -Xms512m -XX:MaxPermSize=2048m'
      }

   stages {
      stage('Unit test') {
          steps {
            sh './gradlew clean testDebug'
          }
          post {
            always {
                junit(allowEmptyResults: true, testResults: '**/*.xml')
            }
          }
      }
   //   stage('Code coverage') {
   //       steps {
   //           sh './gradlew clean sonarComplete'
   //       }
   //       post {
   //          success {
   //             androidLint canComputeNew: false, defaultEncoding: '', healthy: '', pattern: '**/build/reports/lint-results*.xml', unHealthy: ''
   //             publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: false, reportDir: 'app/build/reports/jacoco/jacocoTestDebugUnitTestReport/html', reportFiles: 'index.html', reportName: 'Code coverage', reportTitles: 'Code coverage'])
   //          }
   //       }
   //   }
      stage ('Package and Publish'){
              steps {
                sh './bundle-db.sh'
                sh './gradlew clean assembleRelease'
              }
              post {
                 always {
                    archive includes:'**/*.apk'
                 }
                 success {
                     script {
                         env.WORKSPACE = pwd()
                         env.FILENAME = readFile "${env.WORKSPACE}/changelist"
                     }
                     androidApkUpload apkFilesPattern: '**/*.apk', googleCredentialsId: "$GOOGLE_DEVELOPER_CREDENTIALS_ID", recentChangeList: [[language: 'en-GB', text: "${env.FILENAME}"]], trackName: 'beta', rolloutPercentage: '0%'
                 }
              }
      }
   }
}